/**
 * angular-webspeech-directive
 * @version v0.0.1 - 2013-10-20
 * @link https://github.com/jonniespratley/angular-webspeech-directive
 * @author Jonnie Spratley <jonniespratley@me.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
(function(){"use strict";var a,b;a=function(){function a(){this.setMsg("info_setup"),this.supported=this.checkBrowser(),console.log(this)}var b,c,d,e;return b={start:"mic.gif",recording:"mic-animate.gif",blocked:"mic-slash.gif"},c={info_speak_now:"Speak now.",info_stop:"Proccessing your voice...",info_no_speech:'No Speech was detected. You may need to adjust your <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">microphone settings</a>.',info_no_mic:"No microphone was found. Ensure that a microphone is installed and that",info_blocked:"Permission to use microphone is blocked. To change, go to chrome://settings/contentExceptions#media-stream",info_denied:"Permission to use microphone was denied.",info_setup:"Click on the microphone icon to activate voice recognition.",info_upgrade:'Web jsSpeechFactory API is not supported by this browser. Upgrade to <a href="//www.google.com/chrome">Chrome</a> version 25 or later.',info_allow:'Click the "Allow" button above to enable your microphone.'},e=!1,d=null,a.prototype.start=function(){return this.enable(),e=!0,d.start()},a.prototype.stop=function(){return e=!1,d.stop()},a.prototype.checkBrowser=function(){return"webkitSpeechRecognition"in window},a.prototype.setMsg=function(a){return this.message=c[a]?c[a]:a,console.log(a,this.message)},a.prototype.enable=function(){return d=new webkitSpeechRecognition,d.continuous=!0,d.interimResults=!0,d.onstart=this.onstart,d.onerror=this.onerror,d.onend=this.onend,d.onresult=this.onresult},a.prototype.onstart=function(a){return console.log(a)},a.prototype.onend=function(a){return console.log(a)},a.prototype.onresult=function(b){var c,e;if(e="","undefined"==typeof b.results)return d.onend=null,d.stop(),void 0;for(c=b.resultIndex;c<b.results.length;)e+=b.results[c][0].transcript,console.log(e),++c;return a.message=e},a.prototype.onerror=function(a){return console.log(a)},a}(),window.Speech=new a,b=angular.module("jonniespratley.angularWebSpeechDirective",[]),b.service("jsSpeechFactory",["$rootScope",function(a){var b;return b={startTimestamp:null,recognizing:!1,recording:!1,recognition:null,ignoreEnd:null,transcript:null,messages:{info_speak_now:"Speak now.",info_stop:"Proccessing your voice...",info_no_speech:'No Speech was detected. You may need to adjust your <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">microphone settings</a>.',info_no_mic:"No microphone was found. Ensure that a microphone is installed and that",info_blocked:"Permission to use microphone is blocked. To change, go to chrome://settings/contentExceptions#media-stream",info_denied:"Permission to use microphone was denied.",info_setup:"Click on the microphone icon to activate voice recognition.",info_upgrade:'Web jsSpeechFactory API is not supported by this browser. Upgrade to <a href="//www.google.com/chrome">Chrome</a> version 25 or later.',info_allow:'Click the "Allow" button above to enable your microphone.'},model:{icon:null,status:null,message:null,results:null},elements:{icon:".jsSpeechFactory-icon",btn:".jsSpeechFactory-btn",container:".jsSpeechFactory-container",hint:".jsSpeechFactory-hint",status:".jsSpeechFactory-status",message:".jsSpeechFactory-message"},icons:{start:"mic.gif",recording:"mic-animate.gif",blocked:"mic-slash.gif"},init:function(b){return this.options=b,this.scope=b.scope,console.log("jsSpeechFactory.init()",this),"webkitSpeechRecognition"in window?this.setup():this.showUpgrade(),a.Speech=this,this},showInfo:function(a){return console.log("jsSpeechFactory.showInfo()",this),this.model.message=this.messages[a],console.log(a)},showUpgrade:function(){return console.log("jsSpeechFactory.showUpgrade()",this)},setup:function(){return console.log("jsSpeechFactory.setup()",this),this.showInfo("info_setup"),this.model.icon=this.icons.start,this.recognition=new webkitSpeechRecognition,this.recognition.continuous=!0,this.recognition.interimResults=!0,this.recognition.onstart=this.onstart,this.recognition.onerror=this.onerror,this.recognition.onend=this.onend,this.recognition.onresult=this.onresult},start:function(){return console.log("jsSpeechFactory.start()"),this.showInfo("info_allow"),this.changeIcon("blocked"),this.recognition.stop(),this.recognition.start()},toggle:function(){return this.recognizing?this.stop():this.start()},stop:function(){return console.log("jsSpeechFactory.stop()"),this.recognizing=!1,this.recognition.stop(),this.changeIcon("start"),this.showInfo("info_stop")},capitalize:function(a){return this.log(a),a},changeIcon:function(a){return b.model.icon=b.icons[a]},showResults:function(a){return alert(a)},log:function(){return console.log(arguments)},onstart:function(a){return console.log("jsSpeechFactory.onstart()",a),b.recognizing=!0,b.startTimestamp=new Date,b.showInfo("info_speak_now"),b.changeIcon("recording")},onerror:function(a){return console.log("jsSpeechFactory.onerror()",a),"no-speech"===a.error&&(b.model.icon=b.icons.start,b.showInfo("info_no_jsSpeechFactory"),b.ignoreEnd=!0),"audio-capture"===a.error&&(b.model.icon=b.icons.start,b.showInfo("info_no_microphone"),b.ignoreEnd=!0),"not-allowed"===a.error?(a.timeStamp-b.startTimestamp<100?b.showInfo("info_blocked"):b.showInfo("info_denied"),b.ignoreEnd=!0):void 0},onend:function(a){return b.options.onend(a),console.log("jsSpeechFactory.onend()",a),b.recognizing=!1,b.ignoreEnd?void 0:(b.changeIcon("start"),b.transcript?b.showInfo(""):(b.showInfo("info_start"),void 0))},onresult:function(a){var c,d;if(console.log("jsSpeechFactory.onresult()",a),b.recognizing=!1,d="","undefined"==typeof a.results)return this.recognition.onend=null,this.recognition.stop(),b.showUpgrade(),void 0;for(c=a.resultIndex;c<a.results.length;)d+=a.results[c][0].transcript,console.log(d,a.results[c][0]),b.options.onresult(d),++c;return b.showResults(d),b.transcript=b.capitalize(b.transcript)}},window.jsSpeechFactory=b}]),b.directive("jsSpeech",["jsSpeechFactory",function(){return{restrict:"EAC",scope:!0,replace:!0,transclude:!0,template:'<div class="jsSpeechFactory-container"><p ng-bind-html-unsafe="msg"></p><a id="button" class="jsSpeechFactory-btn" ng-click="toggleStartStop()"><img ng-src="{{Speech.icon}}" class="jsSpeechFactory-icon"/></a><textarea id="textarea" rows="4" class="form-control" ng-model="myModel"></textarea></div>',require:"ngModel",link:function(a){var b,c,d,e;return b=a,e=!1,d=new webkitSpeechRecognition,d.continuous=!0,d.interimResults=!0,b.messages={info_speak_now:"Speak now.",info_stop:"Proccessing your voice...",info_no_speech:'No Speech was detected. You may need to adjust your <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">microphone settings</a>.',info_no_mic:"No microphone was found. Ensure that a microphone is installed and that",info_blocked:'Permission to use microphone is blocked. To change, go to <a href="chrome://settings/contentExceptions#media-stream">chrome://settings/contentExceptions#media-stream</a>.',info_denied:"Permission to use microphone was denied.",info_setup:"Click on the microphone icon to enable Web Speech.",info_upgrade:'Web jsSpeechFactory API is not supported by this browser. Upgrade to <a href="//www.google.com/chrome">Chrome</a> version 25 or later.',info_allow:'Click the "Allow" button above to enable your microphone.'},c={start:"https://dl.dropboxusercontent.com/u/26906414/cdn/img/mic.png",recording:"https://dl.dropboxusercontent.com/u/26906414/cdn/img/mic2-animate.gif",blocked:"https://dl.dropboxusercontent.com/u/26906414/cdn/img/mic-slash.png"},b.myModel="",b.msg=b.messages.info_setup,b.Speech={icon:c.start},b.onstart=function(a){return b.$apply(function(){return b.Speech.icon=c.recording}),console.log("onstart",a)},b.onerror=function(a,c){switch(console.log("onerror",a,c),a.error){case"not-allowed":return b.$apply(function(){return b.msg=b.messages.info_blocked});default:return console.log(a)}},b.onresult=function(a){var d,e,f,g,h;for(f=a.resultIndex,console.log("Handle results",a),b.$apply(function(){return b.Speech.icon=c.recording,b.msg="Speak into the mic..."}),d=f,h=[];d<a.results.length;)e=a.results[d][0],g=e.transcript,console.log(a.results[d]),b.myModel=g,a.results[d].isFinal&&(console.log(g),b.myModel=g),h.push(++d);return h},b.reset=function(a){return console.log("reset",a),e=!1,b.Speech.icon=c.start,b.msg=b.messages.info_setup},b.toggleStartStop=function(){return e?(d.stop(),b.reset()):(d.start(),e=!0,b.myModel="",b.Speech.icon=c.blocked)},b.reset(),d.onerror=b.onerror,d.onend=b.reset,d.onresult=b.onresult,d.onstart=b.onstart,console.log(a)}}}])}).call(this);
/**
 * angular-webspeech-directive
 * @version v0.0.1 - 2013-10-19
 * @link https://github.com/jonniespratley/angular-webspeech-directive
 * @author Jonnie Spratley <jonniespratley@me.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
(function(){"use strict";var a;a=angular.module("jonniespratley.angularWebSpeechDirective",[]),a.factory("jsSpeechFactory",["$rootScope",function(){var a;return window.jsSpeechFactory=a={startTimestamp:null,recognizing:!1,recording:!1,recognition:null,ignoreEnd:null,transcript:null,messages:{info_recording:"Speak now.",info_no_jsSpeechFactory:'No jsSpeechFactory was detected. You may need to adjust your <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">microphone settings</a>.',info_no_mic:"No microphone was found. Ensure that a microphone is installed and that",info_blocked:"Permission to use microphone is blocked. To change, go to chrome://settings/contentExceptions#media-stream",info_denied:"Permission to use microphone was denied.",info_start:"Click on the microphone icon and begin speaking for as long as you like.",info_upgrade:'Web jsSpeechFactory API is not supported by this browser. Upgrade to <a href="//www.google.com/chrome">Chrome</a> version 25 or later.',info_allow:'Click the "Allow" button above to enable your microphone.'},model:{icon:null,status:null,message:null,results:null},elements:{icon:angular.element(".jsSpeechFactory-icon"),btn:angular.element(".jsSpeechFactory-btn"),container:angular.element(".jsSpeechFactory-container"),hint:angular.element(".jsSpeechFactory-hint"),status:angular.element(".jsSpeechFactory-status"),message:angular.element(".jsSpeechFactory-message")},icons:{start:"https://dl.dropboxusercontent.com/u/26906414/cdn/img/mic.gif",recording:"https://dl.dropboxusercontent.com/u/26906414/cdn/img/mic-animate.gif",blocked:"https://dl.dropboxusercontent.com/u/26906414/cdn/img/mic-slash.gif"},init:function(a){return this.scope=a,this.log("jsSpeechFactory.init()",this),"webkitSpeechRecognition"in window?this.setup():this.showUpgrade(),this.model.message=this.messages.info_start,this.changeIcon("start"),a.Speech=this},showUpgrade:function(){return this.log("jsSpeechFactory.showUpgrade()",this)},setup:function(){return this.log("jsSpeechFactory.setup()",this),this.recognition=new webkitSpeechRecognition,this.recognition.continuous=!0,this.recognition.interimResults=!0,this.changeIcon("blocked"),this.recognition.onstart=this.onstart,this.recognition.onerror=this.onerror,this.recognition.onend=this.onend,this.recognition.onresult=this.onresult},start:function(){return this.log("jsSpeechFactory.start()"),this.showInfo("info_recording"),this.recognizing=!0,this.startTimestamp=new Date,this.recognition.start()},toggle:function(){return this.recognizing?a.stop():a.start()},changeIcon:function(a){return this.model.icon=this.icons[a]},stop:function(){return this.log("jsSpeechFactory.stop()"),this.recognition.stop(),this.model.message="Stopped",this.showInfo("info_start")},onstart:function(b){return a.log("jsSpeechFactory.onstart()",b),a.recognizing=!0,a.showInfo("info_speak_now"),a.changeIcon("recording")},onerror:function(b){return console.log("jsSpeechFactory.onerror()",b),"no-speech"===b.error&&(a.model.icon=a.icons.start,a.showInfo("info_no_jsSpeechFactory"),a.ignoreEnd=!0),"audio-capture"===b.error&&(a.model.icon=a.icons.start,a.showInfo("info_no_microphone"),a.ignoreEnd=!0),"not-allowed"===b.error?(b.timeStamp-a.startTimestamp<100?a.showInfo("info_blocked"):a.showInfo("info_denied"),a.ignoreEnd=!0):void 0},onend:function(){return console.log("jsSpeechFactory.onend()"),a.recognizing=!1,a.ignoreEnd?void 0:(a.model.icon=a.icons.start,a.transcript?a.showInfo(""):(a.showInfo("info_start"),void 0))},onresult:function(b){var c,d,e;if(a.log("jsSpeechFactory.onresult()",b),a.recognizing=!1,d="","undefined"==typeof b.results)return this.recognition.onend=null,this.recognition.stop(),a.showUpgrade(),void 0;for(c=b.resultIndex;c<b.results.length;)e=b.results[c][0].transcript,a.model.result+=e,console.log(e),b.results[c].isFinal?(a.transcript+=b.results[c][0].transcript,a.stop()):a.transcript+=b.results[c][0].transcript,++c;return a.transcript=a.capitalize(a.transcript)},showInfo:function(b){return a.log("jsSpeechFactory.showInfo()",this),this.message=this.messages[b]},capitalize:function(a){return this.log(a)},linebreak:function(a){return this.log(a)},log:function(){return console.log(arguments)}}}]),a.directive("jsSpeech",["jsSpeechFactory",function(a){return{restrict:"EAC",scope:!0,replace:!0,transclude:!0,templateUrl:"../src/tmpl.html",link:function(b){return b.Speech=a.init(b),console.log("jsSpeechFactory",a,b)}}}])}).call(this);